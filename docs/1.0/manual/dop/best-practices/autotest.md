尽管不能否认手动测试的价值，但自动化测试的需求却在不断增长。自动化测试可以为公司和团队带来许多好处：效率高、覆盖面广。
如何最好地完成自动化测试呢？
在本文中，我将展示自动化测试中的一些最佳实践，希望这些对你能有所帮助。
# 设计原则
好的接口测试必须遵守 AIR 原则，即 Automatic(自动化)、Independent(独立性)、Repeatable(可重复)。
• 自动化：应该是全自动执行的，并且非交互式的。测试用例通常是被定期执行的，执行过程必须完全自动化才有意义。
• 独立性：为了保证自动化测试稳定可靠且便于维护，场景之间应尽量避免互相调用，也不依赖执行的先后次序。
• 可重复执行：可以在不同的环境重复执行的，不能受到外界环境的影响。因为测试用例通常会被放到持续集成中，对外部环境（网络、服务、中间件等）有依赖，容易导致持续集成机制的不可用。为了保证测试用例可重复执行，自动化测试数据必须是独立的。需要注意：
a) 设置全局参数配置，接口请求的URL使用相对路径，入参参数涉及到环境相关的使用全局变量。
b) 新增场景有名称唯一性校验的，请求入参的名称应尽量使用Mock随机数或者先通过删除接口进行唯一性数据的数据清理
# 自动化测试工程搭建
## 测试空间的创建
一个项目下可以创建多个测试空间，测试空间之间无任何关联，不互相影响，是完全隔离的空间。
测试空间名称建议以项目名称+版本号的方式，新版本的测试空间可以通过复制老版本的测试空间来快速创建，并继承原有的测试用例。示例：Erda2.0
![自动化测试空间](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/c5b86f71-0f59-4881-bead-61a3752f90e8.png)
## 场景集的创建
场景集一般以业务场景为导向，按照具体的的模块来划分。不同的场景级之间可以通过拖拽的方式进行编排。
### 数据预置&数据清理
如果场景集下的场景都依赖一些公共的数据，那么我们建议将数据预置的场景放在场景集的最开始，将数据清理的场景放在场景集的最后。这样可以节省重复执行数据预置带来的时间成本。示例如下：
![场景集的数据预置&清理](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/54e9a5b5-7969-460c-bee3-233420562fc9.jpeg)
## 单场景的创建
场景名称的定义要简洁、易懂，便于其他同学一眼便知其大概含义，降低学习成本。格式可以参考：
• 主语+动词+名词    企业添加成员
• 动词+名词    新建应用
• 名词+动词    构建记录查询
不同的场景之间可以通过拖拽的方式进行编排，通过编排来更改不同场景之间的执行顺序。
不同的步骤之间也可以通过拖拽的方式进行编排，通过编排来更改不同步骤之间的执行顺序以及执行方式（并行/串行）。
![场景集](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/5f35cda9-b33a-4f86-aeb5-a2bd6a4d5d78.png)
### 数据预置
数据预置是自动化测试的重要环节，对于自动化用例的稳定性有重要帮助。常用的数据预置有两种方式：
• 执行SQL脚本初始化数据
优点：执行速度快，成功率高
缺点：需要对预置数据的表结构熟悉，SQL脚本容易遗漏个别关联表。由于是数据库手动侵入行为，容易造成后续功能出现主键冲突问题
• 调用新增接口初始化数据
优点：对系统无侵入行为，不影响后续系统运行
缺点：执行速度慢
我们对数据预置的支持是通过数据银行-配置单的方式实现。配置单中可以添加mysql或者redis的脚本，示例如下：
![配置单](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/c6cf4b88-f752-4abf-831c-65fd1817fa2b.png)
### 接口请求
• 接口入参中的请求参数不建议写成固定值，特别是依赖外部数据的，需要使用全局变量。以保证在不同的测试环境可以重复执行。比如新增项目接口，入参需要企业id,集群名称等数据，这些数据都需要从全局变量获取。
• 请求入参中的名称或者编码不能写死，特别是业务有名称重复性校验的，为了保证用例可以重复执行，参数名称后面建议添加时间戳。
• 每个测试场景应该是一个完整的流程，有新增操作的需要对应的删除操作，保证测试场景执行后不会有历史数据生成。
![接口请求](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/894e1b94-1bf6-4025-ac94-ef5acfb2eebb.png)
### 接口校验
接口校验目前支持状态码、响应头以及body的校验。下面列出了常用的接口校验项：
• 每个接口返回状态码校验
• 新增类接口，必须要校验生成的ID或者Code不为空
• 更新或删除类接口，需要校验返回消息中success为true
• 列表查询类接口，需要校验返回的查询记录数是否正确
• 数据详情类接口，需要校验核心字段数据准确性
### 数据清理
每一个场景需要做到Independent(独立性)，那么就需要在场景执行结束后进行数据的清理工作。通常情况下可以使用删除接口清理或者配置单的方式来恢复环境的数据。
# 环境配置
搭建完自动化测试工程后，我们需要新增环境配置来支撑我们的用例调试以及测试计划的执行。一般情况下我们可以给不同的环境分别配置一个环境配置，这样我们使用同一份测试用例来对不同的环境进行测试。示例：
![环境配置](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/eb94d2ab-4ed8-4f46-a6cb-514a6cc16923.png)
## 环境域名
不同的环境通过不同的域名进行区分。参数配置中支持对环境域名进行配置，支持http/https协议。
## Header
除环境域名外，不同的环境还可以支持不同Header的配置。例如在Header中设置Cookie信息，那么在整个测试计划的执行中都将使用该Cookie信息进行操作，无需重复的为每个接口设置Cookie。
## Global
前面提到的在接口请求中为了同一份场景用例能在不同环境中执行，我们需要将请求参数变量化，那么一些公共的、固定的或者一些依赖环境的参数则可以通过Global来设置。例如：数据库信息、平台的账号密码等。
同时参数的名称命名也需要遵循一定的规范，我们建议变量名称以驼峰命名法，例如：orgId、clusterName。常量则以全部大写，下划线分割的形式命名，例如：MYSQL_HOST,MYSQL_PORT
# 调试
配置完环境配置后，则可以对前面添加的接口以及场景进行调试
## 单接口调试
新增接口步骤后，可以通过“保存并执行”按钮来进行单接口调试，调试时可以选择不同的环境来进行调试。执行完成后，可以看到对应接口的返回值以及断言是否正确。
![单接口调试](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/19/384bbe98-56d8-4136-aa5e-0750f22b222d.png)
## 场景调试
单接口调试完成后，可以对整个场景进行调试，同样支持选择不同的环境来进行调试。执行完成后可以通过执行明细查看调试的结果。
![场景调试](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/19/eb4bf9ed-1586-45a7-b56e-7792d9f43697.png)
• 本场景入参：场景中支持添加场景入参，其中场景入参的值分为：引用值和调试值。在单场景调试时会使用调试值，在测试计划执行时会使用引用值。
• 前置接口出参：场景中后面的步骤可以引用前面步骤的出参作为入参。
![前置接口出参](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/24ea23f2-eb0a-4aca-8370-870bef078420.png)
# 执行
所有场景调试完成后，可以通过执行计划来测试我们的被测系统，也可以接入持续集成日常化的回归被测系统。
## 测试计划执行
日常测试过程中我们可以根据项目的版本和模块来划分，新建多个测试计划。当模块提测后，可以选择对应版本对应模块的测试计划来快速回归。
![测试计划](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/19/2319a01b-e8fa-4541-b725-c795f62ed873.png)
同一个测试计划中，也支持加入不同的场景集。
![测试计划执行](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/ae30a012-8f25-4353-871e-113c9c95e045.png)
## CICD
自动化测试最大的价值之一是在持续集成中不断的对项目进行持续测试。实际项目中应用通过流水线构建部署后，可以通过在流水线中添加“自动化测试计划执行”的Action，将自动化测试加入到CICD的流程中。应用构建部署完成后即可进行自动化测试，快速的发现迭代缺陷。
![CICD](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/ff331285-ba74-4268-9e7e-ae5f1f47a2b4.png)
# 测试报告查看
手动触发的测试计划执行以及CICD触发的测试计划执行，都可以通过执行明细查看具体的详情信息。
![测试报告](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/7e4cb8ee-2fe9-46f4-a0f3-dd584ea33b26.png)
# FAQ
## 如何设置Cookie保持
http接口用例执行的过程中经常遇到Cookie过期的问题，我们提供了两种方式来解决Cookie的保持方式：
1、通过参数配置中的Header设置一个全局的Cookie，那么所有使用该参数配置执行的场景都会使用该Cookie
2、将登录步骤作为场景的第一个步骤，那么该场景中后续步骤的Cookie都是使用前一个步骤的Set-Cookie
![cookie保持](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/80f32fcd-68c4-47ae-81a0-f7eeebb0c00f.png)
## 如何进行失败用例定位
测试计划执行完成后，进入执行计划-执行明细中可以查看场景每一个步骤的结果以及日志，日志中可以查看具体断言的预期值和实际返回值。
## 异步接口支持
## jq使用