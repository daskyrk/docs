# 自动化测试最佳实践

## 自动化测试用例设计原则
好的接口自动化用例应该遵守 AIR 原则，即 Automatic(自动化)、Independent(独立性)、Repeatable(可重复)。
- 自动化：应该是全自动执行的，并且非交互式的。测试用例通常是被定期执行的，执行过程必须完全自动化才有意义。
- 独立性：为了保证自动化测试稳定可靠且便于维护，场景用例之间应尽量避免互相调用，也不依赖执行的先后次序。
- 可重复执行：可以在不同的环境重复执行的，不能受到外界环境的影响。因为测试用例通常会被放到持续集成中，对外部环境（网络、服务、中间件等）强依赖容易导致持续集成机制的不可用。
为了保证测试用例可重复执行，自动化测试数据必须是独立的。需要注意以下两点：</br>
a) 设置全局参数配置，接口请求的URL使用相对路径，参数涉及到环境相关的使用全局变量。</br>
b) 新增场景有名称唯一性校验的，请求入参的名称应尽量使用Mock随机数或者新增用例执行前先进行唯一性的数据清理</br>

## 自动化测试工程搭建
### 测试空间的创建
一个项目下可以创建多个测试空间，测试空间之间无任何关联，不互相影响，是完全隔离的空间。
测试空间名称建议以项目名称+版本号的方式，通过复制老版本的测试空间来快速创建新版本的测试空间，来复制原有的测试用例。示例：Erda2.0

![自动化测试空间](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/c5b86f71-0f59-4881-bead-61a3752f90e8.png)

### 场景集的创建
场景集一般以业务场景为导向，按照具体的的模块来划分。不同的场景级之间可以通过拖拽的方式进行编排。

#### 数据预置&数据清理
如果场景集下的场景都依赖一些公共的数据，那么我们建议将数据预置的场景放在场景集的第一个场景中，将数据清理的场景放在场景集的最后一个场景中。这样可以节省每个场景重复执行数据预置带来的时间成本。示例如下：

![场景集的数据预置&清理](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/54e9a5b5-7969-460c-bee3-233420562fc9.jpeg)

### 单场景的创建
场景名称的定义要简洁、易懂，便于其他同学一眼便知其大概含义，降低学习成本。格式可以参考：
- 主语+动词+名词，例如：企业添加成员
- 动词+名词，例如：新建应用
- 名词+动词，例如：构建记录查询
不同的场景之间可以通过拖拽的方式进行编排，通过编排来更改不同场景之间的执行顺序。</br>
不同的步骤之间也可以通过拖拽的方式进行编排，通过编排来更改不同步骤之间的执行顺序以及执行方式（并行/串行）。</br>

![场景集](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/5f35cda9-b33a-4f86-aeb5-a2bd6a4d5d78.png)

#### 数据准备和数据清理
影响自动化稳定性的两大因素是环境和测试数据，测试数据的管理好坏，会直接影响用例的维护成本。</br>
- 一般测试数据的管理有如下建议：
    - 用于自动化的测试数据应该和手工测试数据保持独立
    - 模块间如果用到相同的测试数据，应尽量使用两份
    - 测试环境、预发环境、线上环境的测试数据要隔离
    - 只读测试数据应和状态有改变的测试数据分开
    - 线上环境测试数据要避免干扰正常用户行为 测试数据使用完应恢复到原始状态，尽量避免在环境中留下垃圾数据

常用的数据管理有两种方式：
- 执行SQL脚本初始化或清理数据</br>
优点：执行速度快，成功率高</br>
缺点：需要对预置数据的表结构熟悉，SQL脚本容易遗漏个别关联表。由于是数据库手动侵入行为，容易造成后续功能出现数据冲突问题</br>
- 调用新增接口初始化或清理数据</br>
优点：对系统无侵入行为，不影响后续系统运行</br>
缺点：执行速度慢</br>

Erda中通过数据银行-配置单的方式实现数据准备和数据清理。配置单中可以添加mysql或者redis的脚本，示例如下：

![配置单](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/c6cf4b88-f752-4abf-831c-65fd1817fa2b.png)

#### 接口请求
- 接口入参中的请求参数不建议写成固定值，特别是依赖外部数据的，尽量使用全局变量。以保证在不同的测试环境可以重复执行。比如新增项目接口，入参需要企业id,集群名称等数据，这些参数尽量使用全局参数管理。</br>
- 请求入参中的名称或者编码不建议写成固定值，特别是业务有名称重复性校验的，为了保障用例可以重复执行，参数名称后面建议添加random参数。
- 每个测试场景应该是一个完整的流程，包括数据准备、测试执行、数据清理来实现场景内部闭环，保障测试场景执行后不会有数据残留。

![接口请求](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/894e1b94-1bf6-4025-ac94-ef5acfb2eebb.png)

#### 接口校验
接口校验目前支持状态码、响应头以及 response body的校验。下面列出了常用的接口校验项：
- 返回状态码校验
- 新增类接口建议校验新生成的数据标识不为空
- 更新或删除类接口建议校验返回消息中success为true
- 列表查询类接口建议校验返回的查询记录数是否正确
- 数据详情类接口建议校验核心字段数据准确性

## 环境配置
搭建完自动化测试工程后，需要抽出的全局参数通过新增环境配置维护，以支撑接口自动化用例调试和测试计划的执行。一般情况下根据不同环境或不同业务域来划分创建全局环境变量。示例：

![环境配置](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/eb94d2ab-4ed8-4f46-a6cb-514a6cc16923.png)

### 环境域名
不同的环境通过不同的域名进行区分。参数配置中支持对环境域名进行配置，支持http/https协议。

### Header
除环境域名外，不同的环境还可以支持不同Header的配置。例如在Header中设置Cookie信息，那么在整个测试计划的执行中都将使用该Cookie信息进行操作，无需重复的为每个接口设置Cookie。

### Global
在接口请求中为了同一份场景测试用例能在不同环境中执行，我们需要将请求参数变量化，一些公共的、会随着环境变化的参数抽出来作为Global变量使用。例如：数据库信息、平台的账号密码等。</br>
建议变量名称以驼峰命名法，例如：orgId、clusterName。常量则以全部大写，下划线分割的形式命名，例如：MYSQL_HOST,MYSQL_PORT

## 调试
配置完环境配置后可以对已经添加的接口和场景进行调试，先进行单接口调试，单接口调试通过之后再进行场景调试。

### 单接口调试
新增接口步骤后，可以通过“保存并执行”按钮，选择不同的环境来进行调试。执行后，可以看到接口的返回值以及断言是否正确。

![单接口调试](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/19/384bbe98-56d8-4136-aa5e-0750f22b222d.png)

### 场景调试
场景调试的重点在于上下文接口以及对应出入参的调试。</br>
单接口调试完成后，点击场景中的执行选择环境进行调试，执行完成后可以通过执行明细查看执行的结果。

![场景调试](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/19/eb4bf9ed-1586-45a7-b56e-7792d9f43697.png)

- 本场景入参：场景中支持添加场景入参，其中场景入参的值分为：引用值和调试值。在单场景调试时会使用调试值，在测试计划执行时使用引用值。
- 前置接口出参：场景中后面的步骤可以引用前面步骤的出参作为入参来串联接口间的业务场景。

![前置接口出参](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/24ea23f2-eb0a-4aca-8370-870bef078420.png)

## 执行测试
场景调试完成后，通过执行计划中编排测试场景集来整体执行测试，也可以接入持续集成进行持续测试。

### 测试计划执行
测试过程中可以根据项目的版本或业务域、模块来划分测试计划。冒烟测试、回归测试或集成测试时以测试计划为单位执行。

![测试计划](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/19/2319a01b-e8fa-4541-b725-c795f62ed873.png)

测试计划中支持加入多个场景集以及场景集的编排</br>

![测试计划中场景集编排](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/ae30a012-8f25-4353-871e-113c9c95e045.png)

### CICD
自动化测试最大的价值之一是在持续集成中进行持续测试。实际项目中应用通过流水线构建部署后，可以通过在流水线中添加“自动化测试计划执行”的Action，将自动化测试加入到CICD的流程中。应用构建部署完成后即可进行自动化测试，更早更快速的发现迭代缺陷。</br>

![CICD](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/ff331285-ba74-4268-9e7e-ae5f1f47a2b4.png)

## 测试报告查看
手动触发的测试计划执行以及CICD触发的测试计划执行，都可以通过执行明细查看具体的详情信息。

![测试报告](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/7e4cb8ee-2fe9-46f4-a0f3-dd584ea33b26.png)

## FAQ
### 如何设置Cookie保持
http接口用例执行的过程中经常遇到Cookie过期的问题，我们提供了两种方式来解决Cookie的保持方式：

1、通过参数配置中的Header设置一个全局的Cookie，那么所有使用该参数配置执行的场景都会使用该Cookie

2、将登录步骤作为场景的第一个步骤，那么该场景中后续步骤的Cookie都是使用前一个步骤返回的Set-Cookie

![cookie保持](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/18/80f32fcd-68c4-47ae-81a0-f7eeebb0c00f.png)

### 用例执行失败如何定位
测试计划执行后，进入执行计划-执行明细中可以查看场景每一个步骤的结果以及日志，日志中可以查看具体断言的预期值和实际返回值。

![执行明细](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/19/e09b026c-047e-4881-9b75-128715502b81.png)

### 异步接口测试测试
可以通过以下两种方式：</br>
1. 场景步骤中添加等待 </br>
2. 步骤接口中添加循环策略，如下图配置30s查询一次，最多循环30次退出</br>
![循环策略配置](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/08/19/8c636c6d-4e49-4cbd-88a0-f5be2324dea5.png)

