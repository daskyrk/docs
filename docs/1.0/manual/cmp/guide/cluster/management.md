# 集群管理

集群管理主要包含如下基本功能：
* 添加集群（新建/导入已有）
* 集群配置修改
* 集群升级
* 集群下线

## 添加集群

用户在完成[企业创建](../quick-start/create-org.md)等基本工作后，接下来重点就是完成集群创建，只有完成集群的创建，才能完整使用平台核心功能。

平台中集群创建方式有以下几种：

* 手动创建，主要使用 Erda 工具链
* 一键创建集群
* 导入自建的 Kubernetes 集群

### 导入已创建的集群

Erda 提供了三种导入自建 Kubernetes 集群的方式：

- KubeConfig
- Service Account
- Cluster Agent

>  导入集群的入口： 多云管理平台 -> 资源管理 -> 集群管理 -> 添加集群 -> Kubernetes(导入已创建的Erda Kubernetes集群)

![](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/07/22/425b640a-9499-4363-9efb-3ab263935c99.png)

#### KubeConfig 及 Service Account 方式

适用场景：KubeConfig 及 Service Account 认证方式，适用于集群**有开放 API Server 端口**的场景

集群导入后会对目标初始化,  初始化过程可以通过状态进行查看。初始化过程包含：部署 Erda 监控、集群客户端、镜像仓库等组件、对所有集群节点标记企业标识

![](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/07/22/e2a450bd-5571-4074-ace4-031f9f603ba6.png)



#### Cluster Agent 方式

适用场景：Cluster Agent，适用于集群无开放 API Server 端口场景

导入流程

- 认证方式选择 Cluster Agent，添加集群成功后，会生成集群初始化命令

![](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/07/22/bf8b4df0-befb-4acc-946b-d1a5da117275.png)

- 目标集群执行初始化命令

- Erda 平台查看初始化状态，初始化过程包含：部署 Erda 监控、集群客户端、镜像仓库等组件、对所有集群节点标记企业标识



::: tip
创建完成后集群是需要和具体的[项目](../org-center/project.md)进行绑定，才能被使用起来。
:::

> 项目集群设置的入口：管理中心 -> 项目管理 -> 选择对应的项目 -> 集群设置。

### 一键创建集群
Erda 提供了一键创建集群功能，包含如下 3 种类型：
* 阿里云容器服务集群（托管版）
* 阿里云容器服务集群（专有版）
* 自建集群

其中阿里云容器服务集群需要客户在创建前，先在云资源管理界面添加阿里云账号（包含阿里云容器服务相关权限），以便后台购买阿里云容器服务集群并创建环境；
若是通过自建集群方式构建，则需要客户直接提供已有 IT 资源信息，后台将通过提供的资源创建集群。

> 云账号入口： 多云管理平台 -> 资源管理 -> 云资源管理 -> 云账户


### 验证集群运行状态

* 查看 **多云管理平台 -> 集群总览**

  预期应该能看到导入的集群信息，机器列表等，可以覆盖常规的监控功能。

* 查看 **多云管理平台 -> 资源管理 -> 集群管理**

  预期可以看到集群的基本信息，如机器类型、版本、lb/master数量等

* [CI/CD](../dop/guides/deploy/deploy-from-git.md) 主流程验证

## 集群配置修改
对于已创建的集群，支持修改集群配置。一般来说集群创建后，最可能修改的参数是集群的超卖比，当前超卖比主要针对 CPU 资源，当超卖比设为 2，相当于 1 核 CPU 当作 2 核用，即当请求 1 核 CPU 时，实际初次配置的只有 0.5 核，只是将使用上限设置为 1 核。修改超卖比配置时，需注意如下事项：

* 超卖比只能针对 CPU 资源超卖
* 超卖比不建议在生产环境使用，只在非生产环境使用，节省 CPU 资源
* 在创建完集群后，根据需要修改超卖比，不要在使用过程中修改，影响项目可用资源显示

## 集群升级
集群升级主要是将中心集群管理的边缘集群升级到和中心集群一样的版本，集群升级需注意以下事项：

* 集群升级当前主要由运维人员统一升级，一般用户无需升级；
* 集群升级只升级边缘 SaaS 化集群
* 集群升级只升级较低版本的边缘集群

## 集群下线
平台支持在线集群创建功能的同时，也支持了在线集群回收释放的功能。为了释放集群的时候不会影响在线业务，在集群释放下线前，需要先完成以下准备工作：

* 清理所有运行在该集群上的项目应用运行时 runtime

* 清理所有运行在该集群上的项目中间件 addon

* 修改所有项目的集群设置，清理所有项目对该集群的引用。

> 项目集群设置入口： 管理中心 -> 项目管理 -> 选择项目 -> 集群设置。

注意：集群下线并不会真正意义上销毁集群，只是将集群从平台释放不再纳管进行调度使用，实际的集群资源还在，如果需要真正销毁需要手动关闭所有的机器资源。

> 集群下线入口： 多云管理平台 -> 资源管理 -> 集群管理 -> 操作（集群下线）
