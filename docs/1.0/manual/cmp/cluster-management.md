# 集群管理

集群管理主要包含如下基本功能：
* 添加集群（新建/导入已有）
* 集群配置修改
* 集群升级
* 集群下线
* 添加机器
* 机器下线等

## 添加集群

用户在完成[企业创建](../quick-start/create-org.md)等基本工作后，接下来重点就是完成集群创建，只有完成集群的创建，才能完整使用平台核心功能。

平台中集群创建方式有以下几种：

* 手动创建，主要使用 Erda 工具链
* 一键创建集群

### 手动创建导入
手动创建导入集群，需要手动创建集群并将其导入平台, 步骤如下：
* 在集群创建前，需要先[检查系统规格和参数](../install/requirement.md)
* 然后[手动创建集群](../install/step-by-step.md)
* 最后导入已创建的集群

>  导入集群的入口： 多云管理平台 -> 资源管理 -> 集群管理 -> 添加集群 -> Kubernetes(导入已创建的Erda Kubernetes集群)

![](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2020/06/18/13aed94a-cf2f-4fff-8570-57951548f7ce.png)

::: tip 提示
创建完成后集群是需要和具体的[项目](../org-center/project.md)进行绑定，才能被使用起来。
:::
> 项目集群设置的入口：管理中心 -> 项目管理 -> 选择对应的项目 -> 集群设置。

### 一键创建集群
Erda 提供了一键创建集群功能，包含如下 3 种类型：
* 阿里云容器服务集群（托管版）
* 阿里云容器服务集群（专有版）
* 自建集群

其中阿里云容器服务集群需要客户在创建前，先在云资源管理界面添加阿里云账号（包含阿里云容器服务相关权限），以便后台购买阿里云容器服务集群并创建环境；
若是通过自建集群方式构建，则需要客户直接提供已有 IT 资源信息，后台将通过提供的资源创建集群。

> 云账号入口： 多云管理平台 -> 资源管理 -> 云资源管理 -> 云账户


### 验证集群运行状态

* 查看 `多云管理平台 -> 集群总览`

  预期应该能看到导入的集群信息，机器列表等。可以覆盖常规的监控功能。

* 查看 `多云管理平台 -> 资源管理 -> 集群管理`

  预期可以看到集群的基本信息，如机器类型、版本、lb/master数量等

* [CI/CD](../quick-start/agile-dev.md) 主流程验证

## 集群配置修改
对于已创建的集群，支持修改集群配置。一般来说集群创建后，最可能修改的参数是集群的超卖比，当前超卖比主要针对 CPU 资源，当超卖比设为 2,
相当于 1 核 CPU 当作 2 核用，即当请求 1 核 CPU 时，实际初次配置的只有 0.5 核，只是将使用上限设置为 1 核。修改超卖比配置时，有如下
注意事项：
* 超卖比只能针对 CPU 资源超卖
* 超卖比不建议在生产环境使用，只在非生产环境使用，节省 CPU 资源
* 在创建完集群后，根据需要修改超卖比，不要在使用过程种修改，影响项目可用资源显示

## 集群升级
集群升级主要是将中心集群管理的边缘集群升级到和中心集群一样的版本，集群升级有如下注意事项：
* 集群升级当前主要由运维人员统一升级，一般用户无需升级；
* 集群升级只升级边缘SaaS化集群
* 集群升级只升级较低版本的边缘集群

## 添加机器
当集群资源不足时，需要往集群种添加机器，当前主要有如下两种场景：
* 阿里云容器服务集群添加机器
* 一般集群添加机器

### 阿里云容器服务集群添加机器
对于阿里云容器服务集群，添加机器推荐步骤如下：
* 阿里云界面: 阿里云容器服务集群（ACK） -> 节点 -> 集群扩容

![](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/07/05/c5ef4715-2067-48d2-a25f-68c52fbfdcf9.jpg)

* Erda界面: 添加机器，添加阿里云容器服务集群（ACK）扩容出的节点
> 入口：多云管理平台 -> 资源管理 -> 集群管理 -> 操作（添加机器）


::: tip 提示
只有通过Erda界面添加完机器，这些机器才会被Erda纳管
:::

添加机器还有如下注意点：
* 添加机器时可以打上合适的机器标签，参见[机器标签](./node-labels.md)
* 添加机器时数据磁盘设备参数可选，如果有数据盘，则填写正确的盘符；若无，则忽略

若是阿里云容器服务集群，但是客户提供的却是直接购买的云主机ECS，则首先需要在阿里云容器服务界面，将ECS加入到阿里云容器服务集群
> 入口：阿里云界面容器服务集群 -> 节点 -> 添加已有节点

![](http://terminus-paas.oss-cn-hangzhou.aliyuncs.com/paas-doc/2021/07/05/ccb093df-3bae-469d-8da9-e0cc2dea5b56.png)

### 一般集群添加机器
对于非阿里云容器服务集群，则直接在 Erda 界面，添加机器即可

## 机器下线
平台支持在线进行机器下线的操作，若是机器下线，应先从 Erda 界面下线，再真正释放下线，否则 Erda 会误以为机器宕机，产生误告警。
在机器正式下线前需要完成以下事前准备工作：

* 为防止业务影响和业务数据的丢失，需要下线的机器上不能有 addon 服务还运行着，如有需要手动进行迁移后才能进行下线。
* 关键功能运行的节点不能下线，具体包含 lb 、master、cassandra、es、kafka、nexus、gittar 标签的宿主机。

> 机器下线入口：多云管理平台 -> 集群总览 -> 机器列表（操作：下线）

## 集群下线
平台支持在线集群创建功能的同时，也支持了在线集群回收释放的功能。为了释放集群的时候不会影响在线业务，在集群释放下线前，需要先完成以下准备工作：

* 清理所有运行在该集群上的项目应用运行时 runtime

* 清理所有运行在该集群上的项目中间件 addon

* 修改所有项目的集群设置，清理所有项目对该集群的引用。

> 项目集群设置入口： 管理中心 -> 项目管理 -> 选择项目 -> 集群设置。

注意：集群下线并不会真正意义上销毁集群，只是将集群从平台释放不再纳管进行调度使用，实际的集群资源还在，如果需要真正销毁需要手动关闭所有的机器资源。

> 集群下线入口： 多云管理平台 -> 资源管理 -> 集群管理 -> 操作（集群下线）


